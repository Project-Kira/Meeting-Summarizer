<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Meeting - Real-time Transcription</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 2em; margin-bottom: 10px; }
        .header p { opacity: 0.9; }
        
        .content { padding: 30px; }
        
        .setup-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .setup-section input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            margin-top: 8px;
        }
        .setup-section input:focus {
            outline: none;
            border-color: #667eea;
        }
        .setup-section label {
            font-weight: 600;
            color: #333;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }
        button {
            flex: 1;
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .btn-start {
            background: #10b981;
            color: white;
        }
        .btn-start:hover { background: #059669; transform: translateY(-2px); }
        .btn-start:disabled { background: #d1d5db; cursor: not-allowed; transform: none; }
        
        .btn-stop {
            background: #ef4444;
            color: white;
        }
        .btn-stop:hover { background: #dc2626; transform: translateY(-2px); }
        .btn-stop:disabled { background: #d1d5db; cursor: not-allowed; transform: none; }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        .status.idle { background: #f3f4f6; color: #6b7280; }
        .status.recording { background: #fef3c7; color: #92400e; animation: pulse 2s infinite; }
        .status.processing { background: #dbeafe; color: #1e40af; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .transcript-box {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        .transcript-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .transcript-item .speaker {
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }
        .transcript-item .time {
            font-size: 0.85em;
            color: #9ca3af;
        }
        .transcript-item .text {
            margin-top: 8px;
            line-height: 1.6;
            color: #374151;
        }
        
        .summary-box {
            background: #ecfdf5;
            border: 2px solid #10b981;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        .summary-box h3 {
            color: #047857;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        .summary-box .summary-content {
            background: white;
            padding: 15px;
            border-radius: 8px;
            line-height: 1.6;
            color: #374151;
        }
        
        .meeting-id {
            background: #f3f4f6;
            padding: 10px 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.9em;
            margin-bottom: 20px;
            color: #6b7280;
        }
        
        .info-box {
            background: #eff6ff;
            border-left: 4px solid #3b82f6;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .info-box strong { color: #1e40af; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéôÔ∏è Voice Meeting</h1>
            <p>Real-time Speech ‚Üí Text ‚Üí AI Summary</p>
        </div>
        
        <div class="content">
            <div class="info-box">
                <strong>üåê Browser-based Voice Recognition</strong><br>
                This uses your browser's built-in speech recognition (Chrome/Edge recommended).
                Grant microphone permission when prompted.
            </div>
            
            <div class="setup-section">
                <label>Meeting Title:</label>
                <input type="text" id="meetingTitle" placeholder="e.g., Q4 Planning Meeting">
                
                <label style="margin-top: 15px; display: block;">Your Name:</label>
                <input type="text" id="speakerName" placeholder="e.g., Alice">
            </div>
            
            <div id="meetingId" class="meeting-id" style="display: none;">
                Meeting ID: <span id="meetingIdValue"></span>
            </div>
            
            <div class="controls">
                <button class="btn-start" id="startBtn" onclick="startMeeting()">
                    üé§ Start Voice Meeting
                </button>
                <button class="btn-stop" id="stopBtn" onclick="stopMeeting()" disabled>
                    üõë Stop & Finalize
                </button>
            </div>
            
            <div id="status" class="status idle">
                üí§ Ready to start
            </div>
            
            <div class="transcript-box" id="transcript">
                <p style="color: #9ca3af; text-align: center;">Transcripts will appear here...</p>
            </div>
            
            <div class="summary-box" id="summaryBox" style="display: none;">
                <h3>üìä Live Summary</h3>
                <div class="summary-content" id="summaryContent">
                    Waiting for summary...
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        let meetingId = null;
        let recognition = null;
        let isRecording = false;
        let transcriptCount = 0;
        let summaryInterval = null;

        // Check browser support
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            alert('‚ùå Speech recognition not supported. Please use Chrome or Edge browser.');
        }

        async function startMeeting() {
            const title = document.getElementById('meetingTitle').value.trim() || 
                          `Voice Meeting ${new Date().toLocaleString()}`;
            const speaker = document.getElementById('speakerName').value.trim() || 'You';
            
            // Create meeting
            updateStatus('processing', 'üîÑ Creating meeting...');
            
            try {
                const response = await fetch(`${API_URL}/meetings`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({title, metadata: {source: 'voice_browser'}})
                });
                
                if (!response.ok) throw new Error('Failed to create meeting');
                
                const data = await response.json();
                meetingId = data.id;
                
                document.getElementById('meetingIdValue').textContent = meetingId.substring(0, 13) + '...';
                document.getElementById('meetingId').style.display = 'block';
                
                // Start speech recognition
                startSpeechRecognition(speaker);
                
                // Start summary polling
                summaryInterval = setInterval(fetchSummary, 15000); // Every 15 seconds
                
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('meetingTitle').disabled = true;
                document.getElementById('speakerName').disabled = true;
                
            } catch (error) {
                console.error(error);
                updateStatus('idle', '‚ùå Failed to start meeting. Is backend running?');
            }
        }

        function startSpeechRecognition(speaker) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            recognition.continuous = true;
            recognition.interimResults = false;
            recognition.lang = 'en-US';
            
            recognition.onstart = () => {
                isRecording = true;
                updateStatus('recording', 'üé§ Recording... Speak now!');
            };
            
            recognition.onresult = async (event) => {
                const last = event.results.length - 1;
                const text = event.results[last][0].transcript.trim();
                
                if (text.length > 10) {
                    console.log('Transcript:', text);
                    await sendSegment(speaker, text);
                }
            };
            
            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                if (event.error === 'no-speech') {
                    // Ignore, this is normal
                } else {
                    updateStatus('recording', `‚ö†Ô∏è Error: ${event.error} (still recording)`);
                }
            };
            
            recognition.onend = () => {
                if (isRecording) {
                    // Auto-restart if still recording
                    setTimeout(() => recognition.start(), 100);
                }
            };
            
            recognition.start();
        }

        async function sendSegment(speaker, text) {
            try {
                const response = await fetch(`${API_URL}/ingest/segment`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        meeting_id: meetingId,
                        speaker: speaker,
                        timestamp_iso: new Date().toISOString(),
                        text_segment: text
                    })
                });
                
                if (response.ok) {
                    addTranscriptItem(speaker, text);
                }
            } catch (error) {
                console.error('Failed to send segment:', error);
            }
        }

        function addTranscriptItem(speaker, text) {
            transcriptCount++;
            const transcriptBox = document.getElementById('transcript');
            
            if (transcriptCount === 1) {
                transcriptBox.innerHTML = '';
            }
            
            const item = document.createElement('div');
            item.className = 'transcript-item';
            item.innerHTML = `
                <div class="speaker">${speaker}</div>
                <div class="time">${new Date().toLocaleTimeString()}</div>
                <div class="text">${text}</div>
            `;
            
            transcriptBox.appendChild(item);
            transcriptBox.scrollTop = transcriptBox.scrollHeight;
            
            // Show summary box after 3 segments
            if (transcriptCount === 3) {
                document.getElementById('summaryBox').style.display = 'block';
            }
        }

        async function fetchSummary() {
            if (!meetingId) return;
            
            try {
                const response = await fetch(`${API_URL}/meetings/${meetingId}/summary`);
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.content) {
                        const content = data.content;
                        let html = `<p><strong>Summary:</strong> ${content.summary || 'Generating...'}</p>`;
                        
                        if (content.decisions && content.decisions.length > 0) {
                            html += `<p style="margin-top: 10px;"><strong>Decisions:</strong></p><ul>`;
                            content.decisions.slice(0, 3).forEach(d => {
                                html += `<li>${d.text}</li>`;
                            });
                            html += `</ul>`;
                        }
                        
                        if (content.action_items && content.action_items.length > 0) {
                            html += `<p style="margin-top: 10px;"><strong>Action Items:</strong></p><ul>`;
                            content.action_items.slice(0, 3).forEach(a => {
                                html += `<li>${a.text} (${a.owner || 'TBD'})</li>`;
                            });
                            html += `</ul>`;
                        }
                        
                        document.getElementById('summaryContent').innerHTML = html;
                        document.getElementById('summaryBox').style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Failed to fetch summary:', error);
            }
        }

        async function stopMeeting() {
            isRecording = false;
            
            if (recognition) {
                recognition.stop();
            }
            
            if (summaryInterval) {
                clearInterval(summaryInterval);
            }
            
            updateStatus('processing', 'üîÑ Finalizing meeting...');
            
            try {
                await fetch(`${API_URL}/meetings/${meetingId}/finalize`, {method: 'POST'});
                
                // Wait for final summary
                await new Promise(resolve => setTimeout(resolve, 3000));
                await fetchSummary();
                
                updateStatus('idle', '‚úÖ Meeting finalized! Final summary shown above.');
            } catch (error) {
                console.error('Failed to finalize:', error);
                updateStatus('idle', '‚ö†Ô∏è Meeting stopped but finalization may have failed');
            }
            
            document.getElementById('stopBtn').disabled = true;
        }

        function updateStatus(type, message) {
            const status = document.getElementById('status');
            status.className = `status ${type}`;
            status.textContent = message;
        }

        // Check backend on load
        window.onload = async () => {
            try {
                const response = await fetch(`${API_URL}/healthz`);
                if (response.ok) {
                    updateStatus('idle', '‚úÖ Backend connected - Ready to start');
                } else {
                    updateStatus('idle', '‚ö†Ô∏è Backend not healthy');
                }
            } catch {
                updateStatus('idle', '‚ùå Backend offline. Run: bash dev.sh start');
                document.getElementById('startBtn').disabled = true;
            }
        };
    </script>
</body>
</html>
