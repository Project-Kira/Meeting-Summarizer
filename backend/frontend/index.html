<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Meeting Summarizer - Test Interface</title>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			min-height: 100vh;
			padding: 20px;
		}

		.container {
			max-width: 1400px;
			margin: 0 auto;
		}

		header {
			text-align: center;
			color: white;
			margin-bottom: 30px;
		}

		h1 {
			font-size: 2.5em;
			margin-bottom: 10px;
		}

		.subtitle {
			font-size: 1.2em;
			opacity: 0.9;
		}

		.grid {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 20px;
			margin-bottom: 20px;
		}

		.card {
			background: white;
			border-radius: 12px;
			padding: 25px;
			box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
		}

		.card h2 {
			color: #667eea;
			margin-bottom: 20px;
			font-size: 1.5em;
			border-bottom: 2px solid #667eea;
			padding-bottom: 10px;
		}

		.form-group {
			margin-bottom: 15px;
		}

		label {
			display: block;
			margin-bottom: 5px;
			font-weight: 600;
			color: #333;
		}

		input,
		textarea,
		select {
			width: 100%;
			padding: 10px;
			border: 2px solid #e0e0e0;
			border-radius: 6px;
			font-size: 14px;
			transition: border-color 0.3s;
		}

		input:focus,
		textarea:focus,
		select:focus {
			outline: none;
			border-color: #667eea;
		}

		textarea {
			resize: vertical;
			min-height: 80px;
		}

		button {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			border: none;
			padding: 12px 24px;
			border-radius: 6px;
			font-size: 16px;
			font-weight: 600;
			cursor: pointer;
			transition: transform 0.2s, box-shadow 0.2s;
			width: 100%;
		}

		button:hover {
			transform: translateY(-2px);
			box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
		}

		button:active {
			transform: translateY(0);
		}

		button:disabled {
			opacity: 0.6;
			cursor: not-allowed;
		}

		.status {
			padding: 10px;
			border-radius: 6px;
			margin-top: 15px;
			font-weight: 500;
		}

		.status.success {
			background: #d4edda;
			color: #155724;
			border: 1px solid #c3e6cb;
		}

		.status.error {
			background: #f8d7da;
			color: #721c24;
			border: 1px solid #f5c6cb;
		}

		.status.info {
			background: #d1ecf1;
			color: #0c5460;
			border: 1px solid #bee5eb;
		}

		.segment-list {
			max-height: 400px;
			overflow-y: auto;
			border: 2px solid #e0e0e0;
			border-radius: 6px;
			padding: 10px;
			margin-top: 15px;
		}

		.segment-item {
			background: #f8f9fa;
			padding: 12px;
			border-radius: 6px;
			margin-bottom: 10px;
			border-left: 4px solid #667eea;
		}

		.segment-speaker {
			font-weight: 700;
			color: #667eea;
			margin-bottom: 5px;
		}

		.segment-time {
			font-size: 0.85em;
			color: #666;
			margin-bottom: 5px;
		}

		.segment-text {
			color: #333;
		}

		.summary-content {
			background: #f8f9fa;
			padding: 15px;
			border-radius: 6px;
			margin-top: 15px;
		}

		.summary-section {
			margin-bottom: 20px;
		}

		.summary-section h3 {
			color: #667eea;
			margin-bottom: 10px;
			font-size: 1.2em;
		}

		.summary-text {
			background: white;
			padding: 12px;
			border-radius: 6px;
			line-height: 1.6;
			margin-bottom: 10px;
		}

		.action-item,
		.decision-item,
		.topic-item {
			background: white;
			padding: 10px;
			border-radius: 6px;
			margin-bottom: 8px;
			border-left: 3px solid #667eea;
		}

		.action-item {
			border-left-color: #28a745;
		}

		.decision-item {
			border-left-color: #ffc107;
		}

		.topic-item {
			border-left-color: #17a2b8;
		}

		.websocket-log {
			max-height: 300px;
			overflow-y: auto;
			background: #2d3748;
			color: #e2e8f0;
			padding: 15px;
			border-radius: 6px;
			font-family: 'Courier New', monospace;
			font-size: 13px;
			margin-top: 15px;
		}

		.websocket-log-item {
			margin-bottom: 5px;
			padding: 5px;
			border-left: 3px solid #48bb78;
		}

		.badge {
			display: inline-block;
			padding: 4px 8px;
			border-radius: 12px;
			font-size: 0.85em;
			font-weight: 600;
			margin-left: 8px;
		}

		.badge.success {
			background: #d4edda;
			color: #155724;
		}

		.badge.warning {
			background: #fff3cd;
			color: #856404;
		}

		.badge.info {
			background: #d1ecf1;
			color: #0c5460;
		}

		#meetingId {
			font-family: 'Courier New', monospace;
			font-size: 0.9em;
		}

		.quick-actions {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 10px;
			margin-top: 15px;
		}

		.quick-action-btn {
			padding: 8px 16px;
			font-size: 14px;
		}

		@media (max-width: 1024px) {
			.grid {
				grid-template-columns: 1fr;
			}
		}
	</style>
</head>

<body>
	<div class="container">
		<header>
			<h1>üéôÔ∏è Meeting Summarizer</h1>
			<p class="subtitle">Real-time Meeting Transcription & Summarization</p>
		</header>

		<div class="grid">
			<!-- Left Column -->
			<div>
				<!-- Create Meeting -->
				<div class="card">
					<h2>1Ô∏è‚É£ Create Meeting</h2>
					<div class="form-group">
						<label for="meetingTitle">Meeting Title</label>
						<input type="text" id="meetingTitle" placeholder="Q4 Planning Meeting" value="Test Meeting">
					</div>
					<button onclick="createMeeting()">Create Meeting</button>
					<div id="createStatus"></div>
					<div class="form-group" style="margin-top: 15px;">
						<label for="meetingId">Meeting ID (auto-filled)</label>
						<input type="text" id="meetingId" readonly placeholder="Will appear after creation">
					</div>
				</div>

				<!-- Ingest Segments -->
				<div class="card" style="margin-top: 20px;">
					<h2>2Ô∏è‚É£ Add Transcript Segments</h2>
					<div class="form-group">
						<label for="speaker">Speaker</label>
						<input type="text" id="speaker" placeholder="Alice" value="Alice">
					</div>
					<div class="form-group">
						<label for="segmentText">Transcript Text</label>
						<textarea id="segmentText"
							placeholder="Let's discuss our Q4 goals...">Let's start the meeting and discuss our quarterly objectives.</textarea>
					</div>
					<button onclick="ingestSegment()">Add Segment</button>
					<div class="quick-actions">
						<button class="quick-action-btn"
							onclick="addQuickSegment('Bob', 'I agree. We should focus on three main priorities.')">Add
							Bob's Message</button>
						<button class="quick-action-btn"
							onclick="addQuickSegment('Charlie', 'Let me share the budget breakdown.')">Add Charlie's
							Message</button>
						<button class="quick-action-btn"
							onclick="addQuickSegment('Alice', 'Great discussion. Let\'s finalize by Friday.')">Add
							Alice's Followup</button>
						<button class="quick-action-btn"
							onclick="addQuickSegment('Bob', 'I\'ll prepare the presentation for the board meeting.')">Add
							Action Item</button>
					</div>
					<div id="ingestStatus"></div>
				</div>

				<!-- Segments List -->
				<div class="card" style="margin-top: 20px;">
					<h2>üìù Transcript Segments <span class="badge info" id="segmentCount">0</span></h2>
					<div class="segment-list" id="segmentsList">
						<p style="color: #666; text-align: center;">No segments yet. Add some above!</p>
					</div>
				</div>
			</div>

			<!-- Right Column -->
			<div>
				<!-- Summary -->
				<div class="card">
					<h2>üìä Meeting Summary</h2>
					<button onclick="fetchSummary()">Refresh Summary</button>
					<button onclick="finalizeMeeting()"
						style="margin-top: 10px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">Finalize
						Meeting</button>
					<div id="summaryContent">
						<p style="color: #666; text-align: center; margin-top: 20px;">Summary will appear here after
							adding segments...</p>
					</div>
				</div>

				<!-- WebSocket Log -->
				<div class="card" style="margin-top: 20px;">
					<h2>üîî Real-time Updates <span class="badge success" id="wsStatus">Disconnected</span></h2>
					<button onclick="connectWebSocket()">Connect WebSocket</button>
					<div class="websocket-log" id="wsLog">
						<div style="color: #a0aec0;">WebSocket log will appear here...</div>
					</div>
				</div>

				<!-- Health Check -->
				<div class="card" style="margin-top: 20px;">
					<h2>‚ù§Ô∏è System Health</h2>
					<button onclick="checkHealth()">Check Health</button>
					<div id="healthStatus"></div>
				</div>
			</div>
		</div>
	</div>

	<script>
		const API_BASE = 'http://localhost:8000';
		let currentMeetingId = null;
		let websocket = null;
		let segmentCount = 0;

		// Auto-generate timestamp
		function getTimestamp() {
			return new Date().toISOString();
		}

		// Show status message
		function showStatus(elementId, message, type = 'info') {
			const el = document.getElementById(elementId);
			el.innerHTML = `<div class="status ${type}">${message}</div>`;
			setTimeout(() => el.innerHTML = '', 5000);
		}

		// Create Meeting
		async function createMeeting() {
			const title = document.getElementById('meetingTitle').value;
			if (!title) {
				showStatus('createStatus', '‚ö†Ô∏è Please enter a meeting title', 'error');
				return;
			}

			try {
				const response = await fetch(`${API_BASE}/meetings`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						title: title,
						metadata: { source: 'test-frontend', created: getTimestamp() }
					})
				});

				const data = await response.json();
				currentMeetingId = data.id;
				document.getElementById('meetingId').value = currentMeetingId;
				showStatus('createStatus', `‚úÖ Meeting created: ${data.title}`, 'success');

				// Auto-connect WebSocket
				connectWebSocket();
			} catch (error) {
				showStatus('createStatus', `‚ùå Error: ${error.message}`, 'error');
			}
		}

		// Ingest Segment
		async function ingestSegment() {
			if (!currentMeetingId) {
				showStatus('ingestStatus', '‚ö†Ô∏è Please create a meeting first', 'error');
				return;
			}

			const speaker = document.getElementById('speaker').value;
			const text = document.getElementById('segmentText').value;

			if (!speaker || !text) {
				showStatus('ingestStatus', '‚ö†Ô∏è Please fill in all fields', 'error');
				return;
			}

			try {
				const response = await fetch(`${API_BASE}/ingest/segment`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						meeting_id: currentMeetingId,
						speaker: speaker,
						timestamp_iso: getTimestamp(),
						text_segment: text
					})
				});

				const data = await response.json();
				showStatus('ingestStatus', `‚úÖ Segment added!`, 'success');

				// Add to segments list
				addSegmentToList(speaker, getTimestamp(), text);

				// Clear textarea
				document.getElementById('segmentText').value = '';

				// Auto-refresh summary after a few segments
				if (segmentCount % 3 === 0) {
					setTimeout(fetchSummary, 2000);
				}
			} catch (error) {
				showStatus('ingestStatus', `‚ùå Error: ${error.message}`, 'error');
			}
		}

		// Quick segment
		async function addQuickSegment(speaker, text) {
			document.getElementById('speaker').value = speaker;
			document.getElementById('segmentText').value = text;
			await ingestSegment();
		}

		// Add segment to list
		function addSegmentToList(speaker, timestamp, text) {
			segmentCount++;
			document.getElementById('segmentCount').textContent = segmentCount;

			const list = document.getElementById('segmentsList');
			if (segmentCount === 1) {
				list.innerHTML = '';
			}

			const item = document.createElement('div');
			item.className = 'segment-item';
			item.innerHTML = `
                <div class="segment-speaker">${speaker}</div>
                <div class="segment-time">${new Date(timestamp).toLocaleTimeString()}</div>
                <div class="segment-text">${text}</div>
            `;
			list.appendChild(item);
			list.scrollTop = list.scrollHeight;
		}

		// Fetch Summary
		async function fetchSummary() {
			if (!currentMeetingId) {
				showStatus('ingestStatus', '‚ö†Ô∏è Please create a meeting first', 'error');
				return;
			}

			try {
				const response = await fetch(`${API_BASE}/meetings/${currentMeetingId}/summary`);

				if (response.status === 200) {
					const data = await response.json();
					if (data && data.content) {
						displaySummary(data.content, data.type);
					} else {
						document.getElementById('summaryContent').innerHTML = '<p style="color: #666; text-align: center; margin-top: 20px;">No summary available yet. Add more segments!</p>';
					}
				} else {
					document.getElementById('summaryContent').innerHTML = '<p style="color: #666; text-align: center; margin-top: 20px;">No summary available yet.</p>';
				}
			} catch (error) {
				console.error('Error fetching summary:', error);
			}
		}

		// Display Summary
		function displaySummary(content, type) {
			let html = `<div class="summary-content">`;
			html += `<div style="text-align: right; margin-bottom: 10px;"><span class="badge ${type === 'final' ? 'success' : 'warning'}">${type.toUpperCase()}</span></div>`;

			// Summary text
			if (content.summary) {
				html += `<div class="summary-section">
                    <h3>üìù Summary</h3>
                    <div class="summary-text">${content.summary}</div>
                </div>`;
			}

			// Decisions
			if (content.decisions && content.decisions.length > 0) {
				html += `<div class="summary-section"><h3>‚úÖ Decisions</h3>`;
				content.decisions.forEach(d => {
					html += `<div class="decision-item">${d.text} <span class="badge info">${(d.confidence * 100).toFixed(0)}%</span></div>`;
				});
				html += `</div>`;
			}

			// Action Items
			if (content.action_items && content.action_items.length > 0) {
				html += `<div class="summary-section"><h3>üéØ Action Items</h3>`;
				content.action_items.forEach(a => {
					html += `<div class="action-item">
                        <strong>${a.text}</strong><br>
                        ${a.owner ? `üë§ ${a.owner}` : ''}
                        ${a.due_date_iso ? `üìÖ Due: ${a.due_date_iso}` : ''}
                        ${a.confidence ? `<span class="badge info">${(a.confidence * 100).toFixed(0)}%</span>` : ''}
                    </div>`;
				});
				html += `</div>`;
			}

			// Topics
			if (content.topics && content.topics.length > 0) {
				html += `<div class="summary-section"><h3>üìå Topics</h3>`;
				content.topics.forEach(t => {
					html += `<div class="topic-item">${t.name} ${t.confidence ? `<span class="badge info">${(t.confidence * 100).toFixed(0)}%</span>` : ''}</div>`;
				});
				html += `</div>`;
			}

			html += `</div>`;
			document.getElementById('summaryContent').innerHTML = html;
		}

		// Finalize Meeting
		async function finalizeMeeting() {
			if (!currentMeetingId) {
				alert('Please create a meeting first');
				return;
			}

			if (!confirm('Finalize this meeting? No more segments can be added.')) {
				return;
			}

			try {
				const response = await fetch(`${API_BASE}/meetings/${currentMeetingId}/finalize`, {
					method: 'POST'
				});

				const data = await response.json();
				alert('‚úÖ Meeting finalized! Final summary will be generated...');

				// Fetch final summary after delay
				setTimeout(() => fetchSummary(), 3000);
			} catch (error) {
				alert(`Error: ${error.message}`);
			}
		}

		// Connect WebSocket
		function connectWebSocket() {
			if (!currentMeetingId) {
				alert('Please create a meeting first');
				return;
			}

			if (websocket) {
				websocket.close();
			}

			const wsUrl = `ws://localhost:8000/ws/${currentMeetingId}`;
			websocket = new WebSocket(wsUrl);

			websocket.onopen = () => {
				document.getElementById('wsStatus').textContent = 'Connected';
				document.getElementById('wsStatus').className = 'badge success';
				addWsLog('‚úÖ WebSocket connected', 'success');
			};

			websocket.onmessage = (event) => {
				const data = JSON.parse(event.data);
				addWsLog(`üì® ${JSON.stringify(data)}`, 'info');

				// Auto-refresh on updates
				if (data.type === 'summary_update' || data.type === 'final_summary') {
					fetchSummary();
				}
			};

			websocket.onerror = () => {
				addWsLog('‚ùå WebSocket error', 'error');
			};

			websocket.onclose = () => {
				document.getElementById('wsStatus').textContent = 'Disconnected';
				document.getElementById('wsStatus').className = 'badge warning';
				addWsLog('‚ö†Ô∏è WebSocket disconnected', 'warning');
			};
		}

		// Add WebSocket log
		function addWsLog(message, type) {
			const log = document.getElementById('wsLog');
			const item = document.createElement('div');
			item.className = 'websocket-log-item';
			item.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
			log.appendChild(item);
			log.scrollTop = log.scrollHeight;
		}

		// Check Health
		async function checkHealth() {
			try {
				const response = await fetch(`${API_BASE}/healthz`);
				const data = await response.json();

				let html = `<div class="status success">`;
				html += `<strong>Status:</strong> ${data.status}<br>`;
				html += `<strong>Database:</strong> ${data.database}<br>`;
				html += `<strong>Mode:</strong> ${data.inference}<br>`;
				html += `<strong>Meetings:</strong> ${data.meetings || 0}<br>`;
				html += `<strong>Segments:</strong> ${data.total_segments || 0}`;
				html += `</div>`;

				document.getElementById('healthStatus').innerHTML = html;
			} catch (error) {
				showStatus('healthStatus', `‚ùå Error: ${error.message}`, 'error');
			}
		}

		// Initialize
		window.onload = () => {
			console.log('Meeting Summarizer Frontend Loaded');
			checkHealth();
		};
	</script>
</body>

</html>